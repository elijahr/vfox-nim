# yamllint disable rule:line-length

name: test

# yamllint disable rule:truthy
on:
  # yamllint enable rule:truthy
  workflow_dispatch: {}
  pull_request:
    branches: ["*"]
    paths:
      - .github/workflows/test.yml # changes to this file
      - lib/** # changes to library functions
      - hooks/** # changes to vfox lua hooks
      - spec/** # changes to lua tests
      - test/** # changes to integration tests
      - .luacheckrc # lua linting config
      - .pre-commit-config.yaml # pre-commit hooks config
      - .yamllint.yml # yaml linting config
      - stylua.toml # lua formatting config
  push:
    branches: ["main"]
    tags: ["*"]
    paths:
      - .github/workflows/test.yml # changes to this file
      - lib/** # changes to library functions
      - hooks/** # changes to vfox lua hooks
      - spec/** # changes to lua tests
      - test/** # changes to integration tests
      - .luacheckrc # lua linting config
      - .pre-commit-config.yaml # pre-commit hooks config
      - .yamllint.yml # yaml linting config
      - stylua.toml # lua formatting config

jobs:
  # Pre-commit checks (linting, formatting)
  lint:
    name: Lint

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install mise and .tool-versions
        uses: jdx/mise-action@v2

      - name: Install lua tools (Windows)
        if: runner.os == 'Windows'
        run: |
          mise exec -- luarocks.exe --lua-version 5.1 install busted
          mise exec -- luarocks.exe --lua-version 5.1 install luacheck

      - name: Install lua tools (Linux and macOS)
        if: runner.os != 'Windows'
        run: |
          mise exec -- luarocks --lua-version 5.1 install busted
          mise exec -- luarocks --lua-version 5.1 install luacheck

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1

  # Test Lua plugin implementation
  lua_tests:
    name: Lua unit tests / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout plugin
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Lua 5.1 binary (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          curl -L -o lua51 https://github.com/elijahr/luabinaries/releases/latest/download/lua51
          chmod +x lua51
          file lua51
          ldd lua51 || true
          ./lua51 -v || echo "Direct execution failed with exit code $?"
          sudo mv lua51 /usr/local/bin/lua5.1
          ls -la /usr/local/bin/lua5.1
          which lua5.1
          /usr/local/bin/lua5.1 -v || echo "Failed with exit code $?"

      - name: Install Lua 5.1 binary (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          if [[ "$(uname -m)" == "arm64" ]]; then
            curl -L -o lua51 https://github.com/elijahr/luabinaries/releases/latest/download/lua51-macos-arm64
          else
            curl -L -o lua51 https://github.com/elijahr/luabinaries/releases/latest/download/lua51-macos-x64
          fi
          chmod +x lua51
          sudo mv lua51 /usr/local/bin/lua5.1
          lua5.1 -v

      - name: Install Lua 5.1 binary (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          curl -L -o lua51.exe https://github.com/elijahr/luabinaries/releases/latest/download/lua51.exe
          mkdir -p "$HOME/bin"
          mv lua51.exe "$HOME/bin/lua5.1.exe"
          echo "$HOME/bin" >> "$GITHUB_PATH"
          "$HOME/bin/lua5.1.exe" -v

      - name: Install LuaRocks
        uses: leafo/gh-actions-luarocks@v6
        with:
          withLuaPath: /usr/local/bin

      - name: Install mise and .tool-versions
        uses: jdx/mise-action@v2

      - name: Install lua tools
        run: |
          luarocks install busted
          luarocks install luacheck

      - name: Run Lua unit tests
        run: |
          # Test with Lua 5.1 (vfox compatibility - gopher-lua)
          lua5.1 "$(which busted)" spec/ -v

  # Test mise integration (with integration test script)
  mise_integration_test:
    name: Mise integration tests / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout plugin
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Lua 5.1 binary (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          curl -L -o lua51 https://github.com/elijahr/luabinaries/releases/latest/download/lua51
          chmod +x lua51
          file lua51
          ldd lua51 || true
          ./lua51 -v || echo "Direct execution failed with exit code $?"
          sudo mv lua51 /usr/local/bin/lua5.1
          ls -la /usr/local/bin/lua5.1
          which lua5.1
          /usr/local/bin/lua5.1 -v || echo "Failed with exit code $?"

      - name: Install Lua 5.1 binary (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          if [[ "$(uname -m)" == "arm64" ]]; then
            curl -L -o lua51 https://github.com/elijahr/luabinaries/releases/latest/download/lua51-macos-arm64
          else
            curl -L -o lua51 https://github.com/elijahr/luabinaries/releases/latest/download/lua51-macos-x64
          fi
          chmod +x lua51
          sudo mv lua51 /usr/local/bin/lua5.1
          lua5.1 -v

      - name: Install Lua 5.1 binary (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          curl -L -o lua51.exe https://github.com/elijahr/luabinaries/releases/latest/download/lua51.exe
          mkdir -p "$HOME/bin"
          mv lua51.exe "$HOME/bin/lua5.1.exe"
          echo "$HOME/bin" >> "$GITHUB_PATH"
          "$HOME/bin/lua5.1.exe" -v

      - name: Install LuaRocks
        uses: leafo/gh-actions-luarocks@v6
        with:
          withLuaPath: /usr/local/bin

      - name: Install mise and .tool-versions
        uses: jdx/mise-action@v2

      - name: Install Luarocks dependencies
        run: |
          luarocks install busted
          luarocks install luacheck

      - name: Run mise integration tests
        shell: bash
        run: |
          mise exec -- "$(which busted)" test/mise-integration_spec.lua -v
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MISE_YES: 1

  # Test vfox integration (with integration test script)
  vfox_integration_test:
    name: vfox integration tests / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout plugin
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Lua 5.1 binary (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          curl -L -o lua51 https://github.com/elijahr/luabinaries/releases/latest/download/lua51
          chmod +x lua51
          file lua51
          ldd lua51 || true
          ./lua51 -v || echo "Direct execution failed with exit code $?"
          sudo mv lua51 /usr/local/bin/lua5.1
          ls -la /usr/local/bin/lua5.1
          which lua5.1
          /usr/local/bin/lua5.1 -v || echo "Failed with exit code $?"

      - name: Install Lua 5.1 binary (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          if [[ "$(uname -m)" == "arm64" ]]; then
            curl -L -o lua51 https://github.com/elijahr/luabinaries/releases/latest/download/lua51-macos-arm64
          else
            curl -L -o lua51 https://github.com/elijahr/luabinaries/releases/latest/download/lua51-macos-x64
          fi
          chmod +x lua51
          sudo mv lua51 /usr/local/bin/lua5.1
          lua5.1 -v

      - name: Install Lua 5.1 binary (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          curl -L -o lua51.exe https://github.com/elijahr/luabinaries/releases/latest/download/lua51.exe
          mkdir -p "$HOME/bin"
          mv lua51.exe "$HOME/bin/lua5.1.exe"
          echo "$HOME/bin" >> "$GITHUB_PATH"
          "$HOME/bin/lua5.1.exe" -v

      - name: Install LuaRocks
        uses: leafo/gh-actions-luarocks@v6
        with:
          withLuaPath: /usr/local/bin

      - name: Install vfox and .tool-versions (Windows)
        uses: MinoruSekine/setup-scoop@v4.0.2
        if: runner.os == 'Windows'
        with:
          apps: vfox

      - name: Install vfox and .tool-versions (Linux and macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            echo "deb [trusted=yes] https://apt.fury.io/versionfox/ /" | sudo tee /etc/apt/sources.list.d/versionfox.list
            sudo apt-get update
            sudo apt-get install -y vfox
          else
            brew tap version-fox/tap
            brew install vfox
          fi

      - name: Install vfox tools and busted
        run: |
          vfox install --all --yes
          luarocks install busted

      - name: Run vfox integration tests
        shell: bash
        run: |
          lua5.1 "$(which busted)" test/vfox-integration_spec.lua -v
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
