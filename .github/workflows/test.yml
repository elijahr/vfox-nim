# yamllint disable rule:line-length

name: test

# yamllint disable rule:truthy
on:
  # yamllint enable rule:truthy
  workflow_dispatch: {}
  pull_request:
    branches: ["*"]
    paths:
      - .github/workflows/test.yml # changes to this file
      - lib/** # changes to library functions
      - hooks/** # changes to vfox lua hooks
      - spec/** # changes to lua tests
      - test/** # changes to integration tests
      - .luacheckrc # lua linting config
      - .pre-commit-config.yaml # pre-commit hooks config
      - .yamllint.yml # yaml linting config
      - stylua.toml # lua formatting config
  push:
    branches: ["main"]
    tags: ["*"]
    paths:
      - .github/workflows/test.yml # changes to this file
      - lib/** # changes to library functions
      - hooks/** # changes to vfox lua hooks
      - spec/** # changes to lua tests
      - test/** # changes to integration tests
      - .luacheckrc # lua linting config
      - .pre-commit-config.yaml # pre-commit hooks config
      - .yamllint.yml # yaml linting config
      - stylua.toml # lua formatting config

jobs:
  # Pre-commit checks (linting, formatting)
  lint:
    name: Lint

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1

  # Test Lua plugin implementation
  lua_tests:
    name: Lua unit tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout plugin
        uses: actions/checkout@v5

      - name: Install Lua and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.4 liblua5.4-dev luarocks
          sudo luarocks install busted
          sudo luarocks install luacheck

      - name: Run Lua linting
        run: luacheck .

      - name: Run Lua unit tests
        run: busted spec/ -v

  # Test mise integration (with integration test script)
  mise_integration_test:
    name: Mise integration tests / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout plugin
        uses: actions/checkout@v5

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Run mise integration tests
        shell: bash
        run: |
          chmod +x test/mise-integration.sh
          bash test/mise-integration.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Test vfox integration (with integration test script)
  vfox_integration_test:
    name: vfox integration tests / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout plugin
        uses: actions/checkout@v5

      - name: Install vfox
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            echo "deb [trusted=yes] https://apt.fury.io/versionfox/ /" | sudo tee /etc/apt/sources.list.d/versionfox.list
            sudo apt-get update
            sudo apt-get install -y vfox
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew tap version-fox/tap
            brew install vfox
          fi

      - name: Run vfox integration tests
        shell: bash
        run: |
          chmod +x test/vfox-integration.sh
          bash test/vfox-integration.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
