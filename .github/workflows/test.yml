# yamllint disable rule:line-length

name: test

# yamllint disable rule:truthy
on:
  # yamllint enable rule:truthy
  workflow_dispatch: {}
  pull_request:
    branches: ["*"]
    paths:
      - .github/workflows/test.yml # changes to this file
      - lib/** # changes to library functions
      - hooks/** # changes to vfox lua hooks
      - spec/** # changes to lua tests
      - test/** # changes to integration tests
      - .luacheckrc # lua linting config
      - .pre-commit-config.yaml # pre-commit hooks config
      - .yamllint.yml # yaml linting config
      - stylua.toml # lua formatting config
  push:
    branches: ["main"]
    tags: ["*"]
    paths:
      - .github/workflows/test.yml # changes to this file
      - lib/** # changes to library functions
      - hooks/** # changes to vfox lua hooks
      - spec/** # changes to lua tests
      - test/** # changes to integration tests
      - .luacheckrc # lua linting config
      - .pre-commit-config.yaml # pre-commit hooks config
      - .yamllint.yml # yaml linting config
      - stylua.toml # lua formatting config

jobs:
  # Pre-commit checks (linting, formatting)
  lint:
    name: Lint

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install mise and .tool-versions
        uses: jdx/mise-action@v2

      - name: Install lua tools (Windows)
        if: runner.os == 'Windows'
        run: |
          mise exec -- luarocks.exe --lua-version 5.1 install busted
          mise exec -- luarocks.exe --lua-version 5.1 install luacheck

      - name: Install lua tools (Linux and macOS)
        if: runner.os != 'Windows'
        run: |
          mise exec -- luarocks --lua-version 5.1 install busted
          mise exec -- luarocks --lua-version 5.1 install luacheck

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1

  # Test Lua plugin implementation
  lua_tests:
    name: Lua unit tests / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout plugin
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Lua
        uses: leafo/gh-actions-lua@v12
        with:
          luaVersion: "5.1"

      - name: Install LuaRocks
        uses: leafo/gh-actions-luarocks@v6

      - name: Install mise and .tool-versions
        uses: jdx/mise-action@v2

      - name: Install lua tools
        run: |
          luarocks install busted
          luarocks install luacheck

      - name: Run Lua unit tests
        run: |
          # Test with Lua 5.1 (vfox compatibility - gopher-lua)
          lua5.1 "$(which busted)" spec/ -v

  # Test mise integration (with integration test script)
  mise_integration_test:
    name: Mise integration tests / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout plugin
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Lua
        uses: leafo/gh-actions-lua@v12
        with:
          luaVersion: "5.1"

      - name: Install LuaRocks
        uses: leafo/gh-actions-luarocks@v6

      - name: Install mise and .tool-versions
        uses: jdx/mise-action@v2

      - name: Install Luarocks dependencies
        run: |
          luarocks install busted
          luarocks install luacheck

      - name: Run mise integration tests
        shell: bash
        run: |
          mise exec -- "$(which busted)" test/mise-integration_spec.lua -v
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MISE_YES: 1

  # Test vfox integration (with integration test script)
  vfox_integration_test:
    name: vfox integration tests / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout plugin
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Lua
        uses: leafo/gh-actions-lua@v12
        with:
          luaVersion: "5.1"

      - name: Install LuaRocks
        uses: leafo/gh-actions-luarocks@v6

      - name: Install vfox and .tool-versions (Windows)
        uses: MinoruSekine/setup-scoop@v4.0.2
        if: runner.os == 'Windows'
        with:
          apps: vfox

      - name: Install vfox and .tool-versions (Linux and macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            echo "deb [trusted=yes] https://apt.fury.io/versionfox/ /" | sudo tee /etc/apt/sources.list.d/versionfox.list
            sudo apt-get update
            sudo apt-get install -y vfox
          else
            brew tap version-fox/tap
            brew install vfox
          fi

      - name: Install vfox tools and busted
        run: |
          vfox install --all --yes
          luarocks install busted

      - name: Run vfox integration tests
        shell: bash
        run: |
          lua5.1 "$(which busted)" test/vfox-integration_spec.lua -v
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
